<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>ä¼˜å…ˆçº§å€’ç½®</title>
      <link href="/blog/2021/12/16/%E4%BC%98%E5%85%88%E7%BA%A7%E5%80%92%E7%BD%AE/"/>
      <url>/blog/2021/12/16/%E4%BC%98%E5%85%88%E7%BA%A7%E5%80%92%E7%BD%AE/</url>
      
        <content type="html"><![CDATA[<h1 id="å¤šçº¿ç¨‹ä¸­çš„ä¼˜å…ˆçº§å€’ç½®"><a href="#å¤šçº¿ç¨‹ä¸­çš„ä¼˜å…ˆçº§å€’ç½®" class="headerlink" title="å¤šçº¿ç¨‹ä¸­çš„ä¼˜å…ˆçº§å€’ç½®"></a>å¤šçº¿ç¨‹ä¸­çš„ä¼˜å…ˆçº§å€’ç½®</h1><p>ä¼˜å…ˆçº§å€’ç½®æ˜¯æŒ‡ä¸€ä¸ªä½ä¼˜å…ˆçº§çº¿ç¨‹èƒ½é˜»æ­¢ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çº¿ç¨‹çš„æ‰§è¡Œâ€”å®ƒæ˜¯è°ƒåº¦å’ŒåŒæ­¥ä¹‹é—´çš„ä¸€ä¸ªä¸å¹²å‡€çš„ç›¸äº’ä½œç”¨ç»“æœã€‚è°ƒåº¦è§„åˆ™è¦æ±‚ä¸€ä¸ªçº¿ç¨‹è¿è¡Œï¼Œä½†æ˜¯åŒæ­¥è¦æ±‚è¿è¡Œå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥ä¸¤ä¸ªçº¿ç¨‹çš„ä¼˜å…ˆçº§å¥½åƒè¢«å€’ç½®äº†ã€‚</p><h3 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h3><p>å½“ä¸€ä¸ªä½ä¼˜å…ˆçº§çº¿ç¨‹è·å¾—ä¸€ä¸ªå…±äº«çš„èµ„æºï¼ˆå¦‚ï¼šäº’æ–¥é‡), å¹¶ä¸”è¢«ä¸€ä¸ªéšååœ¨åŒæ ·èµ„æºä¸Šé˜»å¡çš„é«˜ä¼˜å…ˆçº§çº¿ç¨‹æŠ¢å æ—¶ï¼Œä¼˜å…ˆçº§å€’ç½®å‘ç”Ÿã€‚å½“åªæœ‰ä¸¤ä¸ªçº¿ç¨‹æ—¶ï¼Œä½ä¼˜å…ˆçº§çº¿ç¨‹ç„¶åå°†è¢«å…è®¸æ‰§è¡Œï¼Œæœ€åé‡Šæ”¾äº’æ–¥é‡ã€‚ç„¶è€Œï¼Œå¦‚æœåœ¨å®ƒä»¬ä¹‹é—´æœ‰ç¬¬ä¸‰ä¸ªçº¿ç¨‹å‡†å¤‡å¥½æ—¶ï¼Œå®ƒèƒ½é˜»æ­¢ä½ä¼˜å…ˆçº§çº¿ç¨‹è¿è¡Œï¼Œå› ä¸ºä½ä¼˜å…ˆçº§çº¿ç¨‹æ‹¥æœ‰é«˜ä¼˜å…ˆçº§çº¿ç¨‹éœ€è¦çš„äº’æ–¥é‡ï¼Œä¸­é—´ä¼˜å…ˆçº§çº¿ç¨‹ä¹Ÿå°±é˜»æ­¢äº†é«˜ä¼˜å…ˆçº§çº¿ç¨‹çš„æ‰§è¡Œã€‚</p><h2 id="å¼•ç”¨"><a href="#å¼•ç”¨" class="headerlink" title="å¼•ç”¨"></a>å¼•ç”¨</h2><p>POSIXå¤šçº¿ç¨‹ç¨‹åºè®¾.pdf</p>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å¤šçº¿ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GCD-åŸºæœ¬æ•°æ®ç»“æ„</title>
      <link href="/blog/2021/12/16/GCD-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
      <url>/blog/2021/12/16/GCD-%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<h2 id="source-code-URL"><a href="#source-code-URL" class="headerlink" title="source code URL"></a>source code URL</h2><p><a href="https://github.com/apple/swift-corelibs-libdispatch/tree/macosforge/libdispatch-200">https://github.com/apple/swift-corelibs-libdispatch/tree/macosforge/libdispatch-200</a></p><h2 id="åº“çš„ç¼–ç è§„èŒƒ"><a href="#åº“çš„ç¼–ç è§„èŒƒ" class="headerlink" title="åº“çš„ç¼–ç è§„èŒƒ"></a>åº“çš„ç¼–ç è§„èŒƒ</h2><p>1.xx_s å¸¦_såç¼€éƒ½æ˜¯struct, å¸¦xx_tåç¼€éƒ½æ˜¯xx_sçš„æŒ‡é’ˆç±»å‹å®šä¹‰ï¼štypedef xx_s xx_t;<br>2.dou åŸºæœ¬ä»£è¡¨dispatch object union<br>3.DISPATCH_STRUCT_HEADER å®å°±æ˜¯dispatch_object åŸºç±»å­—æ®µ<br>4.DISPATCH_VTABLE_HEADER å®ç”¨æ¥å®šä¹‰è™šå‡½æ•°è¡¨<br>5.posix pthread APIå¸¦åç¼€_npè¡¨ç¤ºnot portable. <a href="radar::https://stackoverflow.com/questions/2238564/pthread-functions-np-suffix">radar::https://stackoverflow.com/questions/2238564/pthread-functions-np-suffix</a></p><h3 id="dispatch-object-s-in-object-internal-h"><a href="#dispatch-object-s-in-object-internal-h" class="headerlink" title="dispatch_object_s in object_internal.h"></a>dispatch_object_s in object_internal.h</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//dispatch_object_t ç±»å‹æ˜¯ä¸€ä¸ªuion ç”¨è¿‡æ¥æ¨¡æ‹Ÿæ ¹ç±»ï¼ˆdispatch_object_tï¼‰ï¼Œå…¶ä¸­__attribute__((transparent_union)) è®©ç¼–è¯‘å™¨ï¼Œä¸åšå¼ºç±»å‹æ£€æŸ¥</span><span class="token keyword">typedef</span> <span class="token keyword">union</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span> <span class="token operator">*</span>_do<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_continuation_s</span> <span class="token operator">*</span>_dc<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span>_dq<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_s</span> <span class="token operator">*</span>_dqa<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_group_s</span> <span class="token operator">*</span>_dg<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_source_s</span> <span class="token operator">*</span>_ds<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_source_attr_s</span> <span class="token operator">*</span>_dsa<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_semaphore_s</span> <span class="token operator">*</span>_dsema<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_data_s</span> <span class="token operator">*</span>_ddata<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_io_s</span> <span class="token operator">*</span>_dchannel<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_operation_s</span> <span class="token operator">*</span>_doperation<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_disk_s</span> <span class="token operator">*</span>_ddisk<span class="token punctuation">;</span><span class="token punctuation">&#125;</span> <span class="token class-name">dispatch_object_t</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>transparent_union<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DISPATCH_VTABLE_HEADER</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">const</span> do_type<span class="token punctuation">;</span> \ </span></span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> do_kind<span class="token punctuation">;</span> \<span class="token class-name">size_t</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_debug<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \<span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_invoke<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \<span class="token function">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> \<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_dispose<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DISPATCH_STRUCT_HEADER</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">y</span> <span class="token operator">*</span>do_vtable<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token keyword">volatile</span> do_next<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_ref_cnt<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_xref_cnt<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_suspend_cnt<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span>do_targetq<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">void</span> <span class="token operator">*</span>do_ctxt<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">void</span> <span class="token operator">*</span>do_finalizer<span class="token punctuation">;</span></span></span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_vtable_s</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_VTABLE_HEADER</span><span class="token punctuation">(</span>dispatch_object_s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_STRUCT_HEADER</span><span class="token punctuation">(</span>dispatch_object_s<span class="token punctuation">,</span> dispatch_object_vtable_s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">///å®å±•å¼€</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_vtable_s</span> <span class="token punctuation">&#123;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">const</span> do_type<span class="token punctuation">;</span><span class="token comment">//ä¾‹å¦‚ï¼šDISPATCH_QUEUE_TYPE</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> do_kind<span class="token punctuation">;</span>    <span class="token class-name">size_t</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_debug<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_invoke<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_dispose<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span> <span class="token punctuation">&#123;</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_object_vtable_s</span> <span class="token operator">*</span>do_vtable<span class="token punctuation">;</span><span class="token comment">//ç±»ä¼¼C++è™šå‡½æ•°è¡¨</span>    <span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span> <span class="token operator">*</span><span class="token keyword">volatile</span> do_next<span class="token punctuation">;</span><span class="token comment">//volatile å…³é”®å­—è®¾è®¡CPUé«˜é€Ÿç¼“å†²</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_ref_cnt<span class="token punctuation">;</span><span class="token comment">//åº“å†…éƒ¨ä½¿ç”¨çš„å†…å­˜ç®¡ç†</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_xref_cnt<span class="token punctuation">;</span><span class="token comment">//ä½¿ç”¨åº“çš„ç¨‹åºå‘˜ä½¿ç”¨çš„å†…å­˜ç®¡ç†external references çœ‹_dispatch_release</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_suspend_cnt<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span>do_targetq<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>do_ctxt<span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token operator">*</span>do_finalizer<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//æ¶‰åŠæ ¹ç±»å¯¹è±¡çš„ä¸€äº›æ–¹æ³• in object.c</span><span class="token class-name">size_t</span><span class="token function">_dispatch_object_debug_attr</span><span class="token punctuation">(</span><span class="token class-name">dispatch_object_t</span> dou<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token class-name">size_t</span> bufsiz<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token comment">//dou æ˜¯ä¸€ä¸ªunionå¯¹è±¡,å…¶ä¸­_doæ˜¯ dispatch_object_s *</span><span class="token keyword">return</span> <span class="token function">snprintf</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> bufsiz<span class="token punctuation">,</span> <span class="token string">"xrefcnt = 0x%x, refcnt = 0x%x, "</span><span class="token string">"suspend_cnt = 0x%x, locked = %d, "</span><span class="token punctuation">,</span> dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_xref_cnt<span class="token punctuation">,</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_ref_cnt<span class="token punctuation">,</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_suspend_cnt <span class="token operator">/</span> DISPATCH_OBJECT_SUSPEND_INTERVAL<span class="token punctuation">,</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_suspend_cnt <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPATCH_OBJECT_GLOBAL_REFCNT</span><span class="token expression"><span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">0u</span><span class="token punctuation">)</span> </span><span class="token comment">//dispatch global objct å¼•ç”¨è®¡æ•°unsigned int max</span></span><span class="token comment">//**ä¸å¸¦ä¸‹åˆ’çº¿çš„æ–¹æ³•éƒ½æ˜¯å¤–éƒ¨ä½¿ç”¨ï¼Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„,æ¶‰åŠçš„do_xref_cnt.æœ‰ä¸‹åˆ’çº¿çš„æ˜¯åº“å†…éƒ¨ä½¿ç”¨çš„å†…å­˜ç®¡ç†ï¼Œæ¶‰åŠdo_ref_cnt</span><span class="token keyword">void</span><span class="token function">dispatch_retain</span><span class="token punctuation">(</span><span class="token class-name">dispatch_object_t</span> dou<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_xref_cnt <span class="token operator">==</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// global object</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">dispatch_atomic_inc2o</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">,</span> do_xref_cnt<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_CLIENT_CRASH</span><span class="token punctuation">(</span><span class="token string">"Resurrection of an object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">//åº“å†…éƒ¨ä½¿ç”¨</span><span class="token keyword">void</span><span class="token function">_dispatch_retain</span><span class="token punctuation">(</span><span class="token class-name">dispatch_object_t</span> dou<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_ref_cnt <span class="token operator">==</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// global object</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">dispatch_atomic_inc2o</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">,</span> do_ref_cnt<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_CLIENT_CRASH</span><span class="token punctuation">(</span><span class="token string">"Resurrection of an object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__LP64__</span></span><span class="token comment">// the bottom nibble must not be zero, the rest of the bits should be random</span><span class="token comment">// we sign extend the 64-bit version so that a better instruction encoding is</span><span class="token comment">// generated on Intel</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPATCH_OBJECT_LISTLESS</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0xffffffff89abcdef</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPATCH_OBJECT_LISTLESS</span> <span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x89abcdef</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token keyword">void</span><span class="token function">dispatch_release</span><span class="token punctuation">(</span><span class="token class-name">dispatch_object_t</span> dou<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_xref_cnt <span class="token operator">==</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> xref_cnt <span class="token operator">=</span> <span class="token function">dispatch_atomic_dec2o</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">,</span> do_xref_cnt<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fastpath</span><span class="token punctuation">(</span>xref_cnt <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fastpath</span><span class="token punctuation">(</span>xref_cnt <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//å¦‚ä½•å¤–éƒ¨å†…å­˜ç®¡ç†å¼•ç”¨è®¡æ•°ä¸º0ï¼Œéœ€è¦å»ç¡®è®¤å†…éƒ¨å¼•ç”¨è®¡æ•°ã€‚</span><span class="token keyword">if</span> <span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_vtable <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>_dispatch_source_kevent_vtable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">_dispatch_source_xref_release</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_ds<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span><span class="token function">DISPATCH_OBJECT_SUSPENDED</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token comment">// Arguments for and against this assert are within 6705399</span><span class="token function">DISPATCH_CLIENT_CRASH</span><span class="token punctuation">(</span><span class="token string">"Release of a suspended object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token function">_dispatch_release</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">DISPATCH_CLIENT_CRASH</span><span class="token punctuation">(</span><span class="token string">"Over-release of an object"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span><span class="token function">_dispatch_release</span><span class="token punctuation">(</span><span class="token class-name">dispatch_object_t</span> dou<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_ref_cnt <span class="token operator">==</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// global object</span><span class="token punctuation">&#125;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> ref_cnt <span class="token operator">=</span> <span class="token function">dispatch_atomic_dec2o</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">,</span> do_ref_cnt<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fastpath</span><span class="token punctuation">(</span>ref_cnt <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fastpath</span><span class="token punctuation">(</span>ref_cnt <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_next <span class="token operator">!=</span> DISPATCH_OBJECT_LISTLESS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_CRASH</span><span class="token punctuation">(</span><span class="token string">"release while enqueued"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_xref_cnt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_CRASH</span><span class="token punctuation">(</span><span class="token string">"release while external references exist"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token function">dx_dispose</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//#define dx_dispose(x) (x)->do_vtable->do_dispose(x)</span><span class="token punctuation">&#125;</span><span class="token function">DISPATCH_CRASH</span><span class="token punctuation">(</span><span class="token string">"over-release"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span><span class="token function">_dispatch_dispose</span><span class="token punctuation">(</span><span class="token class-name">dispatch_object_t</span> dou<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token class-name">dispatch_queue_t</span> tq <span class="token operator">=</span> dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_targetq<span class="token punctuation">;</span><span class="token class-name">dispatch_function_t</span> func <span class="token operator">=</span> dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_finalizer<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>ctxt <span class="token operator">=</span> dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_ctxt<span class="token punctuation">;</span>dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_vtable <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0x200</span><span class="token punctuation">;</span><span class="token function">free</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>func <span class="token operator">&amp;&amp;</span> ctxt<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">dispatch_async_f</span><span class="token punctuation">(</span>tq<span class="token punctuation">,</span> ctxt<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">_dispatch_release</span><span class="token punctuation">(</span>tq<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//**</span><span class="token comment">///è¿˜æ²¡çœ‹æ˜ç™½</span><span class="token comment">// 6618342 Contact the team that owns the Instrument DTrace probe before</span><span class="token comment">//         renaming this symbol</span><span class="token class-name">dispatch_queue_t</span><span class="token function">_dispatch_wakeup</span><span class="token punctuation">(</span><span class="token class-name">dispatch_object_t</span> dou<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token class-name">dispatch_queue_t</span> tq<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span><span class="token function">DISPATCH_OBJECT_SUSPENDED</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dx_probe</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>dou<span class="token punctuation">.</span>_dq<span class="token operator">-></span>dq_items_tail<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">// _dispatch_source_invoke() relies on this testing the whole suspend count</span><span class="token comment">// word, not just the lock bit. In other words, no point taking the lock</span><span class="token comment">// if the source is suspended or canceled.</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dispatch_atomic_cmpxchg2o</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">,</span> do_suspend_cnt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_COCOA_COMPAT</span></span><span class="token keyword">if</span> <span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_dq <span class="token operator">==</span> <span class="token operator">&amp;</span>_dispatch_main_q<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token function">_dispatch_queue_wakeup_main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token function">_dispatch_retain</span><span class="token punctuation">(</span>dou<span class="token punctuation">.</span>_do<span class="token punctuation">)</span><span class="token punctuation">;</span>tq <span class="token operator">=</span> dou<span class="token punctuation">.</span>_do<span class="token operator">-></span>do_targetq<span class="token punctuation">;</span><span class="token function">_dispatch_queue_push</span><span class="token punctuation">(</span>tq<span class="token punctuation">,</span> dou<span class="token punctuation">.</span>_do<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">return</span> tq<span class="token punctuation">;</span><span class="token comment">// libdispatch does not need this, but the Instrument DTrace</span><span class="token comment">// probe does</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="dispatch-queue-s-in-queue-internal-h"><a href="#dispatch-queue-s-in-queue-internal-h" class="headerlink" title="dispatch_queue_s in queue_internal.h"></a>dispatch_queue_s in queue_internal.h</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">dispatch_continuation_s</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_CONTINUATION_HEADER</span><span class="token punctuation">(</span>dispatch_continuation_s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">dispatch_group_t</span> dc_group<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>dc_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_continuation_s</span> <span class="token operator">*</span><span class="token class-name">dispatch_continuation_t</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_vtable_s</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_VTABLE_HEADER</span><span class="token punctuation">(</span>dispatch_queue_attr_s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_s</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_STRUCT_HEADER</span><span class="token punctuation">(</span>dispatch_queue_attr_s<span class="token punctuation">,</span> dispatch_queue_attr_vtable_s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_vtable_s</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_VTABLE_HEADER</span><span class="token punctuation">(</span>dispatch_queue_s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_STRUCT_HEADER</span><span class="token punctuation">(</span>dispatch_queue_s<span class="token punctuation">,</span> dispatch_queue_vtable_s<span class="token punctuation">)</span><span class="token punctuation">;</span>DISPATCH_QUEUE_HEADER<span class="token punctuation">;</span><span class="token keyword">char</span> dq_label<span class="token punctuation">[</span>DISPATCH_QUEUE_MIN_LABEL_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// must be last</span><span class="token keyword">char</span> _dq_pad<span class="token punctuation">[</span>DISPATCH_QUEUE_CACHELINE_PAD<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// for static queues only</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//å®å±•å¼€</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DISPATCH_CONTINUATION_HEADER</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>do_vtable<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token keyword">volatile</span> do_next<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token class-name">dispatch_function_t</span> dc_func<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">void</span> <span class="token operator">*</span>dc_ctxt</span></span><span class="token keyword">struct</span> <span class="token class-name">dispatch_continuation_s</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//å¯ä»¥å‘ç°continuationå¯¹è±¡å±…ç„¶æ²¡æœ‰å¼•ç”¨è®¡æ•°</span>    <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>do_vtable<span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dispatch_continuation_s</span><span class="token operator">*</span><span class="token keyword">volatile</span> do_next<span class="token punctuation">;</span>    <span class="token comment">//typedef void (*dispatch_function_t)(void *) in base.h</span>    <span class="token class-name">dispatch_function_t</span> dc_func<span class="token punctuation">;</span><span class="token comment">//å¯ä»¥åˆ©ç”¨Cå‡½æ•°</span>    <span class="token keyword">void</span> <span class="token operator">*</span>dc_ctxt<span class="token class-name">dispatch_group_t</span> dc_group<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>dc_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span> <span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_continuation_s</span> <span class="token operator">*</span><span class="token class-name">dispatch_continuation_t</span><span class="token punctuation">;</span><span class="token comment">//å¯ä»¥å‘ç°ç¼–ç¨‹</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DISPATCH_VTABLE_HEADER</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">const</span> do_type<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> do_kind<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token class-name">size_t</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_debug<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_invoke<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token function">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_dispose<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token punctuation">)</span></span></span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_vtable_s</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">const</span> do_type<span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> do_kind<span class="token punctuation">;</span>    <span class="token class-name">size_t</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_debug<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_s</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_invoke<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_s</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_s</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_dispose<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_s</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_s</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_vtable_s</span><span class="token operator">*</span> do_vtable<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_s</span> <span class="token operator">*</span><span class="token keyword">volatile</span> do_next<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_ref_cnt<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_xref_cnt<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_suspend_cnt<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span>do_targetq<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>do_ctxt<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>do_finalizer<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_vtable_s</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token keyword">const</span> do_type<span class="token punctuation">;</span>    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> do_kind<span class="token punctuation">;</span>    <span class="token class-name">size_t</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_debug<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_invoke<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">const</span> do_dispose<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//ä¾‹å¦‚ï¼š</span><span class="token comment">// const struct dispatch_queue_vtable_s _dispatch_queue_vtable = &#123;</span><span class="token comment">// .do_type = DISPATCH_QUEUE_TYPE,</span><span class="token comment">// .do_kind = "queue",</span><span class="token comment">// .do_dispose = _dispatch_queue_dispose,</span><span class="token comment">// .do_invoke = NULL,</span><span class="token comment">// .do_probe = (void *)dummy_function_r0,</span><span class="token comment">// .do_debug = dispatch_queue_debug,</span><span class="token comment">// &#125;;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPATCH_QUEUE_HEADER</span> <span class="token punctuation">\</span><span class="token expression"><span class="token class-name">uint32_t</span> <span class="token keyword">volatile</span> dq_running<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token class-name">uint32_t</span> dq_width<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span> <span class="token operator">*</span><span class="token keyword">volatile</span> dq_items_tail<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span> <span class="token operator">*</span><span class="token keyword">volatile</span> dq_items_head<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">long</span> dq_serialnum<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token class-name">dispatch_queue_t</span> dq_specific_q<span class="token punctuation">;</span></span></span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token punctuation">&#123;</span>    <span class="token comment">//dispatch_object å­—æ®µ</span>    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_vtable_s</span><span class="token operator">*</span> do_vtable<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span><span class="token keyword">volatile</span> do_next<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_ref_cnt<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_xref_cnt<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_suspend_cnt<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span>do_targetq<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>do_ctxt<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>do_finalizer<span class="token punctuation">;</span>    <span class="token comment">//queue ç‰¹æœ‰å­—æ®µ</span>    <span class="token class-name">uint32_t</span> <span class="token keyword">volatile</span> dq_running<span class="token punctuation">;</span><span class="token class-name">uint32_t</span> dq_width<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span> <span class="token operator">*</span><span class="token keyword">volatile</span> dq_items_tail<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_object_s</span> <span class="token operator">*</span><span class="token keyword">volatile</span> dq_items_head<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> dq_serialnum<span class="token punctuation">;</span><span class="token class-name">dispatch_queue_t</span> dq_specific_q<span class="token punctuation">;</span><span class="token keyword">char</span> dq_label<span class="token punctuation">[</span>DISPATCH_QUEUE_MIN_LABEL_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// must be last</span><span class="token keyword">char</span> _dq_pad<span class="token punctuation">[</span>DISPATCH_QUEUE_CACHELINE_PAD<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// for static queues only</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> _dispatch_mgr_q<span class="token punctuation">;</span><span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_attr_vtable_s</span> dispatch_queue_attr_vtable<span class="token punctuation">;</span><span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_vtable_s</span> _dispatch_queue_vtable<span class="token punctuation">;</span><span class="token keyword">extern</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> _dispatch_queue_serial_numbers<span class="token punctuation">;</span><span class="token keyword">extern</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> _dispatch_root_queues<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPATCH_QUEUE_PRIORITY_COUNT</span> <span class="token expression"><span class="token number">4</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DISPATCH_ROOT_QUEUE_COUNT</span> <span class="token expression"><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_COUNT <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span><span class="token comment">// overcommit priority index values need bit 1 set</span><span class="token keyword">enum</span> <span class="token punctuation">&#123;</span>DISPATCH_ROOT_QUEUE_IDX_LOW_PRIORITY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>DISPATCH_ROOT_QUEUE_IDX_LOW_OVERCOMMIT_PRIORITY<span class="token punctuation">,</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_PRIORITY<span class="token punctuation">,</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_OVERCOMMIT_PRIORITY<span class="token punctuation">,</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_PRIORITY<span class="token punctuation">,</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_OVERCOMMIT_PRIORITY<span class="token punctuation">,</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_PRIORITY<span class="token punctuation">,</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_OVERCOMMIT_PRIORITY<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>DISPATCH_ALWAYS_INLINE DISPATCH_CONST<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token class-name">dispatch_queue_t</span><span class="token function">_dispatch_get_root_queue</span><span class="token punctuation">(</span><span class="token keyword">long</span> priority<span class="token punctuation">,</span> bool overcommit<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>overcommit<span class="token punctuation">)</span> <span class="token keyword">switch</span> <span class="token punctuation">(</span>priority<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> DISPATCH_QUEUE_PRIORITY_LOW<span class="token operator">:</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">case</span> DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token operator">:</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">case</span> DISPATCH_QUEUE_PRIORITY_HIGH<span class="token operator">:</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">case</span> DISPATCH_QUEUE_PRIORITY_BACKGROUND<span class="token operator">:</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">switch</span> <span class="token punctuation">(</span>priority<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">case</span> DISPATCH_QUEUE_PRIORITY_LOW<span class="token operator">:</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">case</span> DISPATCH_QUEUE_PRIORITY_DEFAULT<span class="token operator">:</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">case</span> DISPATCH_QUEUE_PRIORITY_HIGH<span class="token operator">:</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">case</span> DISPATCH_QUEUE_PRIORITY_BACKGROUND<span class="token operator">:</span><span class="token keyword">return</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">default</span><span class="token operator">:</span><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token comment">// Note to later developers: ensure that any initialization changes are</span><span class="token comment">// made for statically allocated queues (i.e. _dispatch_main_q).</span><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span><span class="token function">_dispatch_queue_init</span><span class="token punctuation">(</span><span class="token class-name">dispatch_queue_t</span> dq<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>dq<span class="token operator">-></span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_vtable<span class="token punctuation">;</span>dq<span class="token operator">-></span>do_next <span class="token operator">=</span> DISPATCH_OBJECT_LISTLESS<span class="token punctuation">;</span>dq<span class="token operator">-></span>do_ref_cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>dq<span class="token operator">-></span>do_xref_cnt <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">// Default target queue is overcommit!</span>dq<span class="token operator">-></span>do_targetq <span class="token operator">=</span> <span class="token function">_dispatch_get_root_queue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//low_overcommit</span>dq<span class="token operator">-></span>dq_running <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>dq<span class="token operator">-></span>dq_width <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>dq<span class="token operator">-></span>dq_serialnum <span class="token operator">=</span> <span class="token function">dispatch_atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_dispatch_queue_serial_numbers<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="dispatch-semaphore-in-semaphore-internal-h"><a href="#dispatch-semaphore-in-semaphore-internal-h" class="headerlink" title="dispatch semaphore in semaphore_internal.h"></a>dispatch semaphore in semaphore_internal.h</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">dispatch_sema_notify_s</span> <span class="token punctuation">&#123;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_sema_notify_s</span> <span class="token operator">*</span><span class="token keyword">volatile</span> dsn_next<span class="token punctuation">;</span><span class="token class-name">dispatch_queue_t</span> dsn_queue<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>dsn_ctxt<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>dsn_func<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_semaphore_s</span> <span class="token punctuation">&#123;</span><span class="token function">DISPATCH_STRUCT_HEADER</span><span class="token punctuation">(</span>dispatch_semaphore_s<span class="token punctuation">,</span> dispatch_semaphore_vtable_s<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> dsema_value<span class="token punctuation">;</span><span class="token keyword">long</span> dsema_orig<span class="token punctuation">;</span><span class="token class-name">size_t</span> dsema_sent_ksignals<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_MACH_SEM <span class="token operator">&amp;&amp;</span> USE_POSIX_SEM</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">error</span> <span class="token string">"Too many supported semaphore types"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">USE_MACH_SEM</span></span><span class="token class-name">semaphore_t</span> dsema_port<span class="token punctuation">;</span><span class="token class-name">semaphore_t</span> dsema_waiter_port<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">USE_POSIX_SEM</span></span><span class="token class-name">sem_t</span> dsema_sem<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">error</span> <span class="token string">"No supported semaphore type"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token class-name">size_t</span> dsema_group_waiters<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_sema_notify_s</span> <span class="token operator">*</span>dsema_notify_head<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_sema_notify_s</span> <span class="token operator">*</span>dsema_notify_tail<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">extern</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_semaphore_vtable_s</span> _dispatch_semaphore_vtable<span class="token punctuation">;</span><span class="token keyword">typedef</span> <span class="token class-name">uintptr_t</span> _dispatch_thread_semaphore_t<span class="token punctuation">;</span>_dispatch_thread_semaphore_t <span class="token function">_dispatch_get_thread_semaphore</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">_dispatch_put_thread_semaphore</span><span class="token punctuation">(</span>_dispatch_thread_semaphore_t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">_dispatch_thread_semaphore_wait</span><span class="token punctuation">(</span>_dispatch_thread_semaphore_t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">_dispatch_thread_semaphore_signal</span><span class="token punctuation">(</span>_dispatch_thread_semaphore_t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token function">_dispatch_thread_semaphore_dispose</span><span class="token punctuation">(</span>_dispatch_thread_semaphore_t<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//å®å±•å¼€</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">DISPATCH_STRUCT_HEADER</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">y</span> <span class="token operator">*</span>do_vtable<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">x</span> <span class="token operator">*</span><span class="token keyword">volatile</span> do_next<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_ref_cnt<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_xref_cnt<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_suspend_cnt<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span>do_targetq<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">void</span> <span class="token operator">*</span>do_ctxt<span class="token punctuation">;</span> </span><span class="token punctuation">\</span><span class="token expression"><span class="token keyword">void</span> <span class="token operator">*</span>do_finalizer<span class="token punctuation">;</span></span></span><span class="token keyword">struct</span> <span class="token class-name">dispatch_semaphore_s</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_semaphore_vtable_s</span> <span class="token operator">*</span>do_vtable<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_semaphore_s</span> <span class="token operator">*</span><span class="token keyword">volatile</span> do_next<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_ref_cnt<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_xref_cnt<span class="token punctuation">;</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> do_suspend_cnt<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> <span class="token operator">*</span>do_targetq<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>do_ctxt<span class="token punctuation">;</span><span class="token keyword">void</span> <span class="token operator">*</span>do_finalizer<span class="token punctuation">;</span><span class="token keyword">long</span> dsema_value<span class="token punctuation">;</span><span class="token keyword">long</span> dsema_orig<span class="token punctuation">;</span><span class="token class-name">size_t</span> dsema_sent_ksignals<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_MACH_SEM <span class="token operator">&amp;&amp;</span> USE_POSIX_SEM</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">error</span> <span class="token string">"Too many supported semaphore types"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">USE_MACH_SEM</span></span><span class="token class-name">semaphore_t</span> dsema_port<span class="token punctuation">;</span><span class="token class-name">semaphore_t</span> dsema_waiter_port<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">USE_POSIX_SEM</span></span><span class="token class-name">sem_t</span> dsema_sem<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">error</span> <span class="token string">"No supported semaphore type"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token class-name">size_t</span> dsema_group_waiters<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_sema_notify_s</span> <span class="token operator">*</span>dsema_notify_head<span class="token punctuation">;</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_sema_notify_s</span> <span class="token operator">*</span>dsema_notify_tail<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="global-queue-in-queue-c"><a href="#global-queue-in-queue-c" class="headerlink" title="global queue in queue.c"></a>global queue in queue.c</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/***ä¸»è¦æ•°æ®ç»“æ„ï¼š**1. struct dispatch_queue_s _dispatch_root_queues[]**2. static struct dispatch_root_queue_context_s _dispatch_root_queue_contexts[]**3. static struct dispatch_semaphore_s _dispatch_thread_mediator[]*/</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">HAVE_PTHREAD_WORKQUEUES</span></span><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> _dispatch_root_queue_wq_priorities<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> WORKQ_LOW_PRIOQUEUE<span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> WORKQ_LOW_PRIOQUEUE<span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> WORKQ_DEFAULT_PRIOQUEUE<span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span>WORKQ_DEFAULT_PRIOQUEUE<span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> WORKQ_HIGH_PRIOQUEUE<span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> WORKQ_HIGH_PRIOQUEUE<span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> WORKQ_BG_PRIOQUEUE<span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span>WORKQ_BG_PRIOQUEUE<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_semaphore_vtable_s</span> _dispatch_semaphore_vtable <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_type <span class="token operator">=</span> DISPATCH_SEMAPHORE_TYPE<span class="token punctuation">,</span><span class="token punctuation">.</span>do_kind <span class="token operator">=</span> <span class="token string">"semaphore"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>do_dispose <span class="token operator">=</span> _dispatch_semaphore_dispose<span class="token punctuation">,</span><span class="token punctuation">.</span>do_debug <span class="token operator">=</span> _dispatch_semaphore_debug<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//in semaphore.c</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token comment">//mediator æœ‰è§£å†³çº·äº‰çš„äººæ„æ€ï¼Œå°±æ˜¯åˆ©ç”¨semaphoreè¿›è¡ŒåŒæ­¥è°ƒèŠ‚</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_semaphore_s</span> _dispatch_thread_mediator<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_semaphore_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_semaphore_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_semaphore_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_semaphore_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_semaphore_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_semaphore_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_semaphore_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_semaphore_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAX_THREAD_COUNT</span> <span class="token expression"><span class="token number">255</span></span></span><span class="token keyword">struct</span> <span class="token class-name">dispatch_root_queue_context_s</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">HAVE_PTHREAD_WORKQUEUES</span></span><span class="token class-name">pthread_workqueue_t</span> dgq_kworkqueue<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token class-name">uint32_t</span> dgq_pending<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token class-name">uint32_t</span> dgq_thread_pool_size<span class="token punctuation">;</span><span class="token class-name">dispatch_semaphore_t</span> dgq_thread_mediator<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">dispatch_root_queue_context_s</span> _dispatch_root_queue_contexts<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token punctuation">.</span>dgq_thread_mediator <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_thread_mediator<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dgq_thread_pool_size <span class="token operator">=</span> MAX_THREAD_COUNT<span class="token punctuation">,</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token punctuation">.</span>dgq_thread_mediator <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_thread_mediator<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dgq_thread_pool_size <span class="token operator">=</span> MAX_THREAD_COUNT<span class="token punctuation">,</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token punctuation">.</span>dgq_thread_mediator <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_thread_mediator<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dgq_thread_pool_size <span class="token operator">=</span> MAX_THREAD_COUNT<span class="token punctuation">,</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token punctuation">.</span>dgq_thread_mediator <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_thread_mediator<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dgq_thread_pool_size <span class="token operator">=</span> MAX_THREAD_COUNT<span class="token punctuation">,</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token punctuation">.</span>dgq_thread_mediator <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_thread_mediator<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dgq_thread_pool_size <span class="token operator">=</span> MAX_THREAD_COUNT<span class="token punctuation">,</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token punctuation">.</span>dgq_thread_mediator <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_thread_mediator<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dgq_thread_pool_size <span class="token operator">=</span> MAX_THREAD_COUNT<span class="token punctuation">,</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token punctuation">.</span>dgq_thread_mediator <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_thread_mediator<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dgq_thread_pool_size <span class="token operator">=</span> MAX_THREAD_COUNT<span class="token punctuation">,</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token punctuation">.</span>dgq_thread_mediator <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_thread_mediator<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dgq_thread_pool_size <span class="token operator">=</span> MAX_THREAD_COUNT<span class="token punctuation">,</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//è¿™é‡Œæ˜¯global queue</span><span class="token operator">/</span> <span class="token number">6618342</span> Contact the team that owns the Instrument DTrace probe before<span class="token comment">//         renaming this symbol</span><span class="token comment">// dq_running is set to 2 so that barrier operations go through the slow path</span>DISPATCH_CACHELINE_ALIGN<span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> _dispatch_root_queues<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_root_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_suspend_cnt <span class="token operator">=</span> DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ctxt <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queue_contexts<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_label <span class="token operator">=</span> <span class="token string">"com.apple.root.low-priority"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_running <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_width <span class="token operator">=</span> UINT32_MAX<span class="token punctuation">,</span><span class="token punctuation">.</span>dq_serialnum <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_root_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_suspend_cnt <span class="token operator">=</span> DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ctxt <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queue_contexts<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_LOW_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_label <span class="token operator">=</span> <span class="token string">"com.apple.root.low-overcommit-priority"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_running <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_width <span class="token operator">=</span> UINT32_MAX<span class="token punctuation">,</span><span class="token punctuation">.</span>dq_serialnum <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_root_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_suspend_cnt <span class="token operator">=</span> DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ctxt <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queue_contexts<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_label <span class="token operator">=</span> <span class="token string">"com.apple.root.default-priority"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_running <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_width <span class="token operator">=</span> UINT32_MAX<span class="token punctuation">,</span><span class="token punctuation">.</span>dq_serialnum <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_root_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_suspend_cnt <span class="token operator">=</span> DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ctxt <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queue_contexts<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_label <span class="token operator">=</span> <span class="token string">"com.apple.root.default-overcommit-priority"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_running <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_width <span class="token operator">=</span> UINT32_MAX<span class="token punctuation">,</span><span class="token punctuation">.</span>dq_serialnum <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_root_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_suspend_cnt <span class="token operator">=</span> DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ctxt <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queue_contexts<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_label <span class="token operator">=</span> <span class="token string">"com.apple.root.high-priority"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_running <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_width <span class="token operator">=</span> UINT32_MAX<span class="token punctuation">,</span><span class="token punctuation">.</span>dq_serialnum <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_root_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_suspend_cnt <span class="token operator">=</span> DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ctxt <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queue_contexts<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_label <span class="token operator">=</span> <span class="token string">"com.apple.root.high-overcommit-priority"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_running <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_width <span class="token operator">=</span> UINT32_MAX<span class="token punctuation">,</span><span class="token punctuation">.</span>dq_serialnum <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_root_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_suspend_cnt <span class="token operator">=</span> DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ctxt <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queue_contexts<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_label <span class="token operator">=</span> <span class="token string">"com.apple.root.background-priority"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_running <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_width <span class="token operator">=</span> UINT32_MAX<span class="token punctuation">,</span><span class="token punctuation">.</span>dq_serialnum <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_root_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_suspend_cnt <span class="token operator">=</span> DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ctxt <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queue_contexts<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_BACKGROUND_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_label <span class="token operator">=</span> <span class="token string">"com.apple.root.background-overcommit-priority"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_running <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_width <span class="token operator">=</span> UINT32_MAX<span class="token punctuation">,</span><span class="token punctuation">.</span>dq_serialnum <span class="token operator">=</span> <span class="token number">11</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">// 6618342 Contact the team that owns the Instrument DTrace probe before</span><span class="token comment">//         renaming this symbol</span>DISPATCH_CACHELINE_ALIGN<span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> _dispatch_mgr_q <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_mgr_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_suspend_cnt <span class="token operator">=</span> DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">,</span><span class="token punctuation">.</span>do_targetq <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_HIGH_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_label <span class="token operator">=</span> <span class="token string">"com.apple.libdispatch-manager"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_width <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_serialnum <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token comment">//!!!æ³¨æ„åœ¨init.cä¸­å®šä¹‰çš„</span>DISPATCH_CACHELINE_ALIGN<span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span> _dispatch_main_q <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span>DISPATCH_USE_RESOLVERS</span></span><span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_vtable<span class="token punctuation">,</span><span class="token punctuation">.</span>do_targetq <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">.</span>do_ref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_xref_cnt <span class="token operator">=</span> DISPATCH_OBJECT_GLOBAL_REFCNT<span class="token punctuation">,</span><span class="token punctuation">.</span>do_suspend_cnt <span class="token operator">=</span> DISPATCH_OBJECT_SUSPEND_LOCK<span class="token punctuation">,</span><span class="token punctuation">.</span>dq_label <span class="token operator">=</span> <span class="token string">"com.apple.main-thread"</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_running <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_width <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">.</span>dq_serialnum <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token class-name">dispatch_queue_t</span><span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span><span class="token keyword">long</span> priority<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token operator">~</span>DISPATCH_QUEUE_OVERCOMMIT<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">return</span> <span class="token function">_dispatch_get_root_queue</span><span class="token punctuation">(</span>priority<span class="token punctuation">,</span>flags <span class="token operator">&amp;</span> DISPATCH_QUEUE_OVERCOMMIT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token class-name">dispatch_queue_t</span><span class="token function">dispatch_get_current_queue</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">return</span> <span class="token function">_dispatch_queue_get_current</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">:</span> <span class="token function">_dispatch_get_root_queue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//queue initå‡½æ•°å…¥å£</span><span class="token keyword">static</span> <span class="token keyword">void</span><span class="token function">_dispatch_hw_config_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>_dispatch_hw_config<span class="token punctuation">.</span>cc_max_active <span class="token operator">=</span> <span class="token function">_dispatch_get_activecpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>_dispatch_hw_config<span class="token punctuation">.</span>cc_max_logical <span class="token operator">=</span> <span class="token function">_dispatch_get_logicalcpu_max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>_dispatch_hw_config<span class="token punctuation">.</span>cc_max_physical <span class="token operator">=</span> <span class="token function">_dispatch_get_physicalcpu_max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token comment">//init workq æ˜¯åº”è¯¥æ˜¯å¹³å°ç‰¹æ€§çš„ï¼Œç³»ç»Ÿpthreadå†…éƒ¨æœ‰queue</span><span class="token keyword">static</span> <span class="token keyword">inline</span> bool<span class="token function">_dispatch_root_queues_init_workq</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>bool result <span class="token operator">=</span> false<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">HAVE_PTHREAD_WORKQUEUES</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">slowpath</span><span class="token punctuation">(</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"LIBDISPATCH_DISABLE_KWQ"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token keyword">int</span> i<span class="token punctuation">,</span> r<span class="token punctuation">;</span><span class="token class-name">pthread_workqueue_attr_t</span> pwq_attr<span class="token punctuation">;</span>r <span class="token operator">=</span> <span class="token function">pthread_workqueue_attr_init_np</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq_attr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">dispatch_assume_zero</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> DISPATCH_ROOT_QUEUE_COUNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token class-name">pthread_workqueue_t</span> pwq <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token keyword">const</span> <span class="token keyword">int</span> prio <span class="token operator">=</span> _dispatch_root_queue_wq_priorities<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>r <span class="token operator">=</span> <span class="token function">pthread_workqueue_attr_setqueuepriority_np</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq_attr<span class="token punctuation">,</span> prio<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">dispatch_assume_zero</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>r <span class="token operator">=</span> <span class="token function">pthread_workqueue_attr_setovercommit_np</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq_attr<span class="token punctuation">,</span> i <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">dispatch_assume_zero</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>r <span class="token operator">=</span> <span class="token function">pthread_workqueue_create_np</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pwq_attr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">dispatch_assume_zero</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>result <span class="token operator">=</span> result <span class="token operator">||</span> <span class="token function">dispatch_assume</span><span class="token punctuation">(</span>pwq<span class="token punctuation">)</span><span class="token punctuation">;</span>_dispatch_root_queue_contexts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dgq_kworkqueue <span class="token operator">=</span> pwq<span class="token punctuation">;</span><span class="token punctuation">&#125;</span>r <span class="token operator">=</span> <span class="token function">pthread_workqueue_attr_destroy_np</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq_attr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">dispatch_assume_zero</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  <span class="token comment">// HAVE_PTHREAD_WORKQUEUES</span></span><span class="token keyword">return</span> result<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span><span class="token function">_dispatch_root_queues_init_thread_pool</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token keyword">int</span> i<span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> DISPATCH_ROOT_QUEUE_COUNT<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">TARGET_OS_EMBEDDED</span></span><span class="token comment">// some software hangs if the non-overcommitting queues do not</span><span class="token comment">// overcommit when threads block. Someday, this behavior should apply</span><span class="token comment">// to all platforms</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>i <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>_dispatch_root_queue_contexts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dgq_thread_pool_size <span class="token operator">=</span>_dispatch_hw_config<span class="token punctuation">.</span>cc_max_active<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">USE_MACH_SEM</span></span><span class="token comment">// override the default FIFO behavior for the pool semaphores</span><span class="token class-name">kern_return_t</span> kr <span class="token operator">=</span> <span class="token function">semaphore_create</span><span class="token punctuation">(</span><span class="token function">mach_task_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>_dispatch_thread_mediator<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dsema_port<span class="token punctuation">,</span> SYNC_POLICY_LIFO<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">DISPATCH_VERIFY_MIG</span><span class="token punctuation">(</span>kr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">dispatch_assume_zero</span><span class="token punctuation">(</span>kr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">dispatch_assume</span><span class="token punctuation">(</span>_dispatch_thread_mediator<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dsema_port<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression">USE_POSIX_SEM</span></span><span class="token comment">/* XXXRW: POSIX semaphores don't support LIFO? */</span><span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_dispatch_thread_mediator<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dsema_sem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">dispatch_assume_zero</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span><span class="token function">DISPATCH_CRASH</span><span class="token punctuation">(</span><span class="token string">"Thread pool creation failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token punctuation">&#125;</span><span class="token keyword">static</span> <span class="token keyword">void</span><span class="token function">_dispatch_root_queues_init</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>context DISPATCH_UNUSED<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">_dispatch_root_queues_init_workq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token comment">//è¿™ä¸ªifç¡®å®šäº†queue ç”±libdispatchæä¾›</span><span class="token function">_dispatch_root_queues_init_thread_pool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">countof</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span>DISPATCH_EXPORT DISPATCH_NOTHROW<span class="token keyword">void</span><span class="token function">libdispatch_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token function">dispatch_assert</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_COUNT <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">dispatch_assert</span><span class="token punctuation">(</span>DISPATCH_ROOT_QUEUE_COUNT <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">dispatch_assert</span><span class="token punctuation">(</span>DISPATCH_QUEUE_PRIORITY_LOW <span class="token operator">==</span><span class="token operator">-</span>DISPATCH_QUEUE_PRIORITY_HIGH<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">dispatch_assert</span><span class="token punctuation">(</span><span class="token function">countof</span><span class="token punctuation">(</span>_dispatch_root_queues<span class="token punctuation">)</span> <span class="token operator">==</span>DISPATCH_ROOT_QUEUE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">dispatch_assert</span><span class="token punctuation">(</span><span class="token function">countof</span><span class="token punctuation">(</span>_dispatch_root_queue_contexts<span class="token punctuation">)</span> <span class="token operator">==</span>DISPATCH_ROOT_QUEUE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">HAVE_PTHREAD_WORKQUEUES</span></span><span class="token function">dispatch_assert</span><span class="token punctuation">(</span><span class="token function">countof</span><span class="token punctuation">(</span>_dispatch_root_queue_wq_priorities<span class="token punctuation">)</span> <span class="token operator">==</span>DISPATCH_ROOT_QUEUE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_ENABLE_THREAD_POOL</span></span><span class="token function">dispatch_assert</span><span class="token punctuation">(</span><span class="token function">countof</span><span class="token punctuation">(</span>_dispatch_thread_mediator<span class="token punctuation">)</span> <span class="token operator">==</span>DISPATCH_ROOT_QUEUE_COUNT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token function">dispatch_assert</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_source_s</span><span class="token punctuation">)</span> <span class="token operator">==</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span><span class="token punctuation">)</span> <span class="token operator">-</span> DISPATCH_QUEUE_CACHELINE_PAD<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_DEBUG</span></span><span class="token function">dispatch_assert</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">dispatch_queue_s</span><span class="token punctuation">)</span> <span class="token operator">%</span> DISPATCH_CACHELINE_SIZE<span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token function">_dispatch_thread_key_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dispatch_queue_key<span class="token punctuation">,</span> _dispatch_queue_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">_dispatch_thread_key_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dispatch_sema4_key<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>_dispatch_thread_semaphore_dispose<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">_dispatch_thread_key_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dispatch_cache_key<span class="token punctuation">,</span> _dispatch_cache_cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">_dispatch_thread_key_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dispatch_io_key<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">_dispatch_thread_key_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dispatch_apply_key<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_PERF_MON</span></span><span class="token function">_dispatch_thread_key_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dispatch_bcounter_key<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_USE_RESOLVERS </span><span class="token comment">// rdar://problem/8541707</span></span>_dispatch_main_q<span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_queue_vtable<span class="token punctuation">;</span>_dispatch_main_q<span class="token punctuation">.</span>do_targetq <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_root_queues<span class="token punctuation">[</span>DISPATCH_ROOT_QUEUE_IDX_DEFAULT_OVERCOMMIT_PRIORITY<span class="token punctuation">]</span><span class="token punctuation">;</span>_dispatch_data_empty<span class="token punctuation">.</span>do_vtable <span class="token operator">=</span> <span class="token operator">&amp;</span>_dispatch_data_vtable<span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token function">_dispatch_thread_setspecific</span><span class="token punctuation">(</span>dispatch_queue_key<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_dispatch_main_q<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">DISPATCH_USE_PTHREAD_ATFORK</span></span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">dispatch_assume_zero</span><span class="token punctuation">(</span><span class="token function">pthread_atfork</span><span class="token punctuation">(</span>dispatch_atfork_prepare<span class="token punctuation">,</span>dispatch_atfork_parent<span class="token punctuation">,</span> dispatch_atfork_child<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token function">_dispatch_hw_config_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> iOS </category>
          
      </categories>
      
      
        <tags>
            
            <tag> GCD </tag>
            
            <tag> libdispatch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C é¢„å¤„ç†å™¨</title>
      <link href="/blog/2021/09/27/C%20Preprocessor/"/>
      <url>/blog/2021/09/27/C%20Preprocessor/</url>
      
        <content type="html"><![CDATA[<h1 id="C-é¢„å¤„ç†å™¨"><a href="#C-é¢„å¤„ç†å™¨" class="headerlink" title="C é¢„å¤„ç†å™¨"></a>C é¢„å¤„ç†å™¨</h1><p>C å¤„ç†å™¨å…¶å®ä¹Ÿæœ‰å¾ˆå¤šæŠ€å·§å’Œæ³¨æ„ç‚¹ï¼Œæˆ‘å¤§è‡´çœ‹è¿‡äº†æ‰€æœ‰sectionï¼Œå¯¹äºæŸäº›åœ°æ–¹ï¼Œæˆ‘è¿˜æ˜¯æ²¡æœ‰ç†è§£ï¼Œä¾‹å¦‚tokenizationå¤„ç†æµç¨‹ï¼Œæˆ‘å¹¶æ²¡çœ‹æ‡‚ã€‚å¤§è‡´ç¿»è¯‘äº†ä¸€éƒ¨åˆ†ï¼Œåé¢é™„ä¸Šå®˜ç½‘åœ°å€ç”¨äºä»¥åæŸ¥é˜…ã€‚å¸Œæœ›ï¼Œåé¢èƒ½é€æ­¥ç†è§£ã€‚</p><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>Cé¢„å¤„ç†å™¨ï¼ˆå‘½ä»¤è¡Œ cpp)æ˜¯ä¸€ä¸ªå®å¤„ç†å™¨ã€‚Cç¼–è¯‘å™¨ä¼šè‡ªåŠ¨è°ƒç”¨å®ƒæ¥é¢„å¤„ç†ä½ çš„ç¨‹åºã€‚Cé¢„å¤„ç†å™¨åªç”¨äºCã€c++å’ŒObjective-Cæºä»£ç ã€‚ä¾‹å¦‚ï¼Œä½ ç”¨å®ƒé¢„å¤„ç†makefileæ–‡ä»¶ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„tabç¬¦éƒ½ä¼šè¢«ç§»é™¤ï¼Œä»è€Œå¯¼è‡´Makefileä¸èƒ½å·¥ä½œã€‚</p><p>è¯è™½å¦‚æ­¤ï¼Œä½ å¯ä»¥åœ¨cè¯­è¨€ä¹‹å¤–çš„åœ°æ–¹ä½¿ç”¨cppã€‚å…¶ä»–ç±»ä¼¼algoliçš„ç¼–ç¨‹è¯­è¨€é€šå¸¸æ˜¯å®‰å…¨çš„(Adaç­‰)ã€‚-traditional-cppæ¨¡å¼ä¿ç•™æ›´å¤šçš„ç©ºç™½ï¼Œå¦åˆ™æ›´å®½å®¹ã€‚è®¸å¤šé—®é¢˜å¯ä»¥é€šè¿‡ç¼–å†™Cæˆ–c++é£æ ¼çš„æ³¨é‡Šè€Œä¸æ˜¯æœ¬åœ°è¯­è¨€æ³¨é‡Šæ¥é¿å…ï¼Œå¹¶ä¿æŒå®çš„ç®€å•æ€§ã€‚</p><p>Cé¢„å¤„ç†å™¨åœ¨æŸäº›ç»†èŠ‚ä¸Šæœ‰æ‰€ä¸åŒã€‚è¿™æœ¬æ‰‹å†Œè®¨è®ºäº†GNU Cé¢„å¤„ç†å™¨ï¼Œå®ƒæä¾›äº†ISOæ ‡å‡†Cç‰¹æ€§çš„ä¸€ä¸ªå°è¶…é›†ã€‚åœ¨å®ƒçš„é»˜è®¤æ¨¡å¼ä¸‹ï¼ŒGNU Cé¢„å¤„ç†å™¨ä¸åšæ ‡å‡†è¦æ±‚çš„ä¸€äº›äº‹æƒ…ã€‚è¿™äº›ç‰¹æ€§å¾ˆå°‘è¢«ä½¿ç”¨ï¼Œå¹¶ä¸”å¯èƒ½ä¼šç»™ç¨‹åºçš„å«ä¹‰å¸¦æ¥æ„æƒ³ä¸åˆ°çš„å˜åŒ–ã€‚è¦è·å¾—ä¸¥æ ¼çš„ISOæ ‡å‡†Cï¼Œæ‚¨åº”è¯¥ä½¿ç”¨-std=c90ã€-std=c99ã€-std=c11æˆ–-std=c17é€‰é¡¹ï¼Œè¿™å–å†³äºæ‚¨æƒ³è¦çš„æ ‡å‡†ç‰ˆæœ¬ã€‚è¦è·å¾—æ‰€æœ‰å¼ºåˆ¶è¯Šæ–­ï¼Œè¿˜å¿…é¡»ä½¿ç”¨-pedanticã€‚</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cpp -std&#x3D;c11 -pedantic [input]<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>CPP é»˜è®¤ä½¿ç”¨UTF-8å­—ç¬¦é›†ï¼Œä½ å¯ä»¥é€šè¿‡-finput-charset= option é€‰é¡¹è¿›è¡ŒæŒ‡å®šè¾“å…¥æ–‡ä»¶çš„å­—ç¬¦é›†ã€‚</p><h2 id="åˆå§‹å¤„ç†"><a href="#åˆå§‹å¤„ç†" class="headerlink" title="åˆå§‹å¤„ç†"></a>åˆå§‹å¤„ç†</h2><p>CPP ä¼šæŠŠè¾“å…¥æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œç„¶åæŒ‰è¡Œè¿›è¡Œå¤„ç†ã€‚è¡Œç»“æŸæ ‡å¿—<code>CR</code>,<code>CR LF</code>,<code>CR</code>.å¯¹äºå¾ˆé•¿çš„ä¸€è¡Œå¯ä»¥ç”¨â€™&#39;è¿›è¡Œæ¢è¡Œå¤„ç†ï¼ˆè¿ç»­è¡Œï¼‰ï¼ŒCPPä¼šæŠŠä»¥â€™&#39;ç»“å°¾çš„è¿ç»­è¡Œåˆå¹¶å›ä¸€ä¸ªå¾ˆé•¿çš„è¡Œï¼Œä¸¤ä¸ªè¿ç»­è¡Œåˆå¹¶ä¸­é—´ä¸ä¼šæ’å…¥ç©ºæ ¼ï¼Œå¯ä»¥ç†è§£ä¸ºç›´æ¥å­—ç¬¦ä¸²æ‹¼æ¥ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">hi</span> <span class="token expression">hello</span><span class="token punctuation">\</span><span class="token expression">world</span></span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> <span class="token operator">*</span>hi <span class="token operator">=</span> <span class="token string">"ni hao"</span><span class="token punctuation">;</span>\\å®hi ä¼šé¢„å¤„ç†æˆhelloworldï¼Œä¸­é—´ä¸ä¼šæœ‰ç©ºæ ¼    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è¡Œæ³¨é‡Šâ€™//â€˜,å—æ³¨é‡Šâ€™/* comments */â€˜ã€‚</p><h2 id="include-search-path"><a href="#include-search-path" class="headerlink" title="include search path"></a>include search path</h2><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œé¢„å¤„ç†å™¨æŸ¥æ‰¾æŒ‡ä»¤#include â€œfileâ€çš„å¼•å·å½¢å¼åŒ…å«çš„å¤´æ–‡ä»¶ï¼Œé¦–å…ˆç›¸å¯¹äºå½“å‰æ–‡ä»¶çš„ç›®å½•ï¼Œç„¶ååœ¨æ ‡å‡†ç³»ç»Ÿç›®å½•çš„é¢„é…ç½®åˆ—è¡¨ä¸­æŸ¥æ‰¾ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ/usr/include/sys/stat.håŒ…å«#include â€œtypes.hâ€ï¼Œ GCCé¦–å…ˆåœ¨/usr/include/sysä¸­æŸ¥æ‰¾types.hï¼Œç„¶ååœ¨å®ƒé€šå¸¸çš„æœç´¢è·¯å¾„ä¸­æŸ¥æ‰¾ã€‚</p><p>å¯¹äºå°–æ‹¬å·å½¢å¼#include <file>ï¼Œé¢„å¤„ç†å™¨çš„é»˜è®¤è¡Œä¸ºæ˜¯åªæŸ¥çœ‹æ ‡å‡†ç³»ç»Ÿç›®å½•ã€‚ç¡®åˆ‡çš„æœç´¢ç›®å½•åˆ—è¡¨å–å†³äºç›®æ ‡ç³»ç»Ÿã€GCCçš„é…ç½®æ–¹å¼ä»¥åŠå®ƒçš„å®‰è£…ä½ç½®ã€‚é€šè¿‡ä½¿ç”¨-vé€‰é¡¹è°ƒç”¨CPPï¼Œå¯ä»¥æ‰¾åˆ°CPPç‰ˆæœ¬çš„é»˜è®¤æœç´¢ç›®å½•åˆ—è¡¨. ä¾‹å¦‚ï¼š<code>cpp -v /dev/null -o /dev/null</code></p><p>æ‚¨å¯ä»¥ä½¿ç”¨è®¸å¤šå‘½ä»¤è¡Œé€‰é¡¹å‘æœç´¢è·¯å¾„æ·»åŠ é¢å¤–çš„ç›®å½•ã€‚æœ€å¸¸ç”¨çš„é€‰é¡¹æ˜¯-Idirï¼Œå®ƒå¯¼è‡´diråœ¨å½“å‰ç›®å½•(æŒ‡ä»¤çš„å¼•å·å½¢å¼)ä¹‹åå’Œæ ‡å‡†ç³»ç»Ÿç›®å½•ä¹‹å‰æœç´¢ã€‚æ‚¨å¯ä»¥åœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®šå¤šä¸ª-Ié€‰é¡¹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç›®å½•å°†æŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºæœç´¢ã€‚</p><p>å¦‚æœä½ éœ€è¦å•ç‹¬æ§åˆ¶â€™ #include â€˜æŒ‡ä»¤çš„å¼•å·å’Œå°–æ‹¬å·å½¢å¼çš„æœç´¢è·¯å¾„ï¼Œä½ å¯ä»¥ä½¿ç”¨-iquoteå’Œ/æˆ–-isystemé€‰é¡¹æ¥ä»£æ›¿-Iã€‚æœ‰å…³è¿™äº›é€‰é¡¹ä»¥åŠå…¶ä»–ä¸€èˆ¬ä¸å¤ªæœ‰ç”¨çš„é€‰é¡¹çš„è¯¦ç»†æè¿°ï¼Œè¯·å‚é˜…è°ƒç”¨ã€‚</p><p>å¦‚æœåœ¨å‘½ä»¤è¡Œä¸­æŒ‡å®šå…¶ä»–é€‰é¡¹ï¼Œæ¯”å¦‚-Iï¼Œå®ƒä¼šå½±å“é¢„å¤„ç†å™¨æœç´¢å¤´æ–‡ä»¶çš„ä½ç½®ï¼Œé‚£ä¹ˆ-vé€‰é¡¹æ‰“å°çš„ç›®å½•åˆ—è¡¨ä¼šåæ˜ é¢„å¤„ç†å™¨ä½¿ç”¨çš„å®é™…æœç´¢è·¯å¾„ã€‚</p><p>æ³¨æ„ï¼Œæ‚¨è¿˜å¯ä»¥ä½¿ç”¨- nodincé€‰é¡¹é˜»æ­¢é¢„å¤„ç†å™¨æœç´¢ä»»ä½•é»˜è®¤çš„ç³»ç»Ÿå¤´ç›®å½•ã€‚å½“ç¼–è¯‘æ“ä½œç³»ç»Ÿå†…æ ¸æˆ–å…¶ä»–ä¸ä½¿ç”¨æ ‡å‡†Cåº“å·¥å…·æˆ–æ ‡å‡†Cåº“æœ¬èº«çš„ç¨‹åºæ—¶ï¼Œè¿™æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p><h2 id="å‡½æ•°å®"><a href="#å‡½æ•°å®" class="headerlink" title="å‡½æ•°å®"></a>å‡½æ•°å®</h2><p>æ‚¨è¿˜å¯ä»¥å®šä¹‰ä¸€äº›å®ï¼Œå…¶ä½¿ç”¨æ–¹å¼ç±»ä¼¼äºå‡½æ•°è°ƒç”¨ã€‚è¿™äº›è¢«ç§°ä¸ºç±»å‡½æ•°å®ã€‚è¦å®šä¹‰ä¸€ä¸ªç±»ä¼¼å‡½æ•°çš„å®ï¼Œä½ å¯ä»¥ä½¿ç”¨ç›¸åŒçš„â€™ #define â€˜æŒ‡ä»¤ï¼Œä½†æ˜¯åœ¨å®åç§°åé¢é©¬ä¸Šæ”¾ä¸€å¯¹æ‹¬å·ã€‚ä¾‹å¦‚,</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">lang_init</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">c_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token function">lang_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>     â†’ <span class="token function">c_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>å‡½æ•°å®åªæœ‰åœ¨åç§°åè·Ÿä¸€å¯¹æ‹¬å·æ—¶æ‰ä¼šå±•å¼€ã€‚å¦‚æœä½ åªå†™åå­—ï¼Œå®ƒå°±ä¸éœ€è¦å†™äº†ã€‚å½“æ‚¨æœ‰ä¸€ä¸ªåŒåçš„å‡½æ•°å’Œä¸€ä¸ªå®ï¼Œå¹¶ä¸”æ‚¨æœ‰æ—¶å¸Œæœ›ä½¿ç”¨è¯¥å‡½æ•°æ—¶ï¼Œè¿™æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">foo</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> </span><span class="token comment">/* optimized inline version */</span></span>â€¦  <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  funcptr <span class="token operator">=</span> foo<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨è¿™é‡Œï¼Œå¯¹<code>foo()</code>çš„è°ƒç”¨å°†ä½¿ç”¨å®ï¼Œä½†å‡½æ•°æŒ‡é’ˆå°†è·å¾—å®é™…å‡½æ•°çš„åœ°å€ã€‚å¦‚æœè¦æ‰©å±•å®ï¼Œå®ƒå°†å¯¼è‡´è¯­æ³•é”™è¯¯ã€‚å¦‚æœåœ¨å®å®šä¹‰ä¸­çš„å®åå’Œåœ†æ‹¬å·ä¹‹é—´åŠ ç©ºæ ¼ï¼Œè¿™å°±ä¸ä¼šå®šä¹‰ä¸€ä¸ªç±»å‡½æ•°å®ï¼Œè€Œæ˜¯å®šä¹‰äº†ä¸€ä¸ªç±»å¯¹è±¡å®ï¼Œå…¶å±•å¼€ç¢°å·§ä»¥ä¸€å¯¹åœ†æ‹¬å·å¼€å§‹ã€‚</p><h2 id="å®˜ç½‘ï¼ˆå¯ä»¥å½“æ‰‹å†Œç¿»é˜…ï¼‰"><a href="#å®˜ç½‘ï¼ˆå¯ä»¥å½“æ‰‹å†Œç¿»é˜…ï¼‰" class="headerlink" title="å®˜ç½‘ï¼ˆå¯ä»¥å½“æ‰‹å†Œç¿»é˜…ï¼‰"></a>å®˜ç½‘ï¼ˆå¯ä»¥å½“æ‰‹å†Œç¿»é˜…ï¼‰</h2><p><a href="https://gcc.gnu.org/onlinedocs/cpp/index.html#SEC_Contents">https://gcc.gnu.org/onlinedocs/cpp/index.html#SEC_Contents</a></p>]]></content>
      
      
      <categories>
          
          <category> ç¼–è¯‘åŸç† </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¼–è¯‘ </tag>
            
            <tag> Cé¢„å¤„ç†å™¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++ newæ“ä½œç¬¦å·çš„ä¸€äº›æ¢ç´¢</title>
      <link href="/blog/2021/09/24/new%E6%93%8D%E4%BD%9C%E7%AC%A6%E5%8F%B7%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A2/"/>
      <url>/blog/2021/09/24/new%E6%93%8D%E4%BD%9C%E7%AC%A6%E5%8F%B7%E7%9A%84%E4%B8%80%E4%BA%9B%E6%8E%A2%E7%B4%A2/</url>
      
        <content type="html"><![CDATA[<h1 id="newå’Œdelete-new-å’Œdelete"><a href="#newå’Œdelete-new-å’Œdelete" class="headerlink" title="newå’Œdelete new[]å’Œdelete[]"></a>newå’Œdelete new[]å’Œdelete[]</h1><h2 id="new-å’Œ-delete"><a href="#new-å’Œ-delete" class="headerlink" title="new å’Œ delete"></a>new å’Œ delete</h2><p>åœ¨C++ä¸­ï¼Œnewå’Œdeleteæ˜¯é…å¯¹ä½¿ç”¨çš„ã€‚è¿™ä¸¤ä¸ªæ“ä½œç¬¦çš„ä½œç”¨æ˜¯ç”¨æ¥åŠ¨æ€åˆ†é…å•ä¸ªç±»å‹çš„å¯¹è±¡ã€‚å¦‚æœnew ä¸€ä¸ªç±»å¯¹è±¡ï¼ŒC++è¯­è¨€ä¼šè‡ªåŠ¨æ’å…¥é»˜è®¤æ„é€ å‡½æ•°çš„è°ƒç”¨ä»£ç ï¼Œ deleteä¸€ä¸ªç±»å¯¹è±¡ï¼ŒC++è¯­è¨€ä¼šè‡ªåŠ¨æ’å…¥ææ„å‡½æ•°çš„è°ƒç”¨ä»£ç ã€‚æ‰€ä»¥ï¼Œå¦‚æœè¿™ä¸ªç±»å¯¹è±¡æœ‰ç»§æ‰¿å…³ç³»ï¼Œææ„å‡½æ•°å¿…é¡»å®ç°æˆè™šå‡½æ•°ï¼ˆé¿å…åŸºç±»å¯¹è±¡æŒ‡é’ˆæŒ‡å‘å­ç±»çš„æ—¶å€™ï¼Œè°ƒç”¨deleteæ“ä½œï¼Œå¦‚æœææ„å‡½æ•°ä¸æ˜¯è™šå‡½æ•°ï¼Œå°±åªä¼šè°ƒç”¨åŸºç±»çš„ææ„å‡½æ•°ï¼Œå­ç±»å°±æ— æ³•ææ„äº†ï¼‰ã€‚</p><h2 id="new-å’Œ-delete-1"><a href="#new-å’Œ-delete-1" class="headerlink" title="new[] å’Œ delete[]"></a>new[] å’Œ delete[]</h2><p>ä¸ºä»€ä¹ˆC++ä¸­æœ‰ä¸ªnew å’Œ deleteåï¼Œä¸ºä»€ä¹ˆè¿˜æ¥ä¸€å¯¹new[] å’Œ delete[]? è¯·çœ‹ä¸‹é¢ä»£ç ï¼š</p><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span><span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">&#123;</span><span class="token keyword">public</span><span class="token operator">:</span>    <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"hello"</span><span class="token operator">&lt;&lt;</span>std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token operator">~</span><span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"destruct"</span><span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    A <span class="token operator">*</span>a <span class="token operator">=</span> <span class="token keyword">new</span> A<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    A <span class="token operator">*</span>b <span class="token operator">=</span> <span class="token keyword">new</span> A<span class="token punctuation">;</span>    <span class="token comment">// delete a; malloc: *** error for object 0x101009208: pointer being freed was not allocated</span>    <span class="token keyword">delete</span> <span class="token punctuation">(</span>A<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">uint64_t</span><span class="token punctuation">)</span>a <span class="token operator">-</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è°ƒç”¨ <code>delete a</code>ä»£ç æ‰§è¡Œæ—¶å€™ï¼Œä¼šå¥”æºƒã€‚ è°ƒç”¨<code>delete (A*)((uint64_t)a - 8)</code>,å¯ä»¥æ­£å¸¸ææ„æ•°ç»„çš„ç¬¬ä¸€ä¸ªAå¯¹è±¡ï¼Œåé¢99å¯¹è±¡æ²¡æœ‰è°ƒç”¨ææ„å‡½æ•°ï¼Œåªæ˜¯è¢«åº•å±‚çš„free å‡½æ•°å›æ”¶äº†å†…å­˜ã€‚</p><p>åœ¨æˆ‘çš„x86_64 MACç”µè„‘ä¸Šï¼ŒC++åœ¨è°ƒç”¨new[]æ“ä½œç¬¦å·æ—¶å€™ï¼Œä¼šå¤šåˆ†é…ä¸€ä¸ª8å­—èŠ‚çš„ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾æ•°ç€çš„sizeã€‚ç„¶åæŠŠåº•å±‚mallocå‡½æ•°è¿”å›çš„æŒ‡é’ˆå€¼åŠ 8åè¿”å›ç»™æˆ‘ä»¬ä»£ç ã€‚è¿™æ ·ï¼Œç”¨æˆ·è°ƒç”¨ delete[]æ“ä½œç¬¦å·æ—¶å€™ï¼Œä¼šå–å‡ºsizeï¼Œç„¶åè¿­ä»£è¿›è¡Œææ„ï¼Œå†å‡8å­—èŠ‚åè°ƒç”¨freeé‡Šæ”¾å†…å­˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> è¯­è¨€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¦‚ä½•å†™å¥½ä¸€ä¸ªbench_markå·¥å…·</title>
      <link href="/blog/2021/09/18/%E5%A6%82%E4%BD%95%E5%86%99%E5%A5%BD%E4%B8%80%E4%B8%AAbench-mark-%E5%B7%A5%E5%85%B7/"/>
      <url>/blog/2021/09/18/%E5%A6%82%E4%BD%95%E5%86%99%E5%A5%BD%E4%B8%80%E4%B8%AAbench-mark-%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<h1 id="bench-mark"><a href="#bench-mark" class="headerlink" title="bench_mark()"></a>bench_mark()</h1><p>å¦‚ä½•ä¼˜é›…çš„å®ç°ä¸€ä¸ªæµ‹è¯•ä»£ç è¿è¡Œæ—¶é—´çš„<code>bench_mark</code>å‡½æ•°ï¼Œtalk is cheap, show me your code.</p><h3 id="bench-mark-h"><a href="#bench-mark-h" class="headerlink" title="bench_mark.h"></a>bench_mark.h</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">bench_mark_ </span><span class="token comment">//guard for #include usage</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">bench_mark_</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>    <span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">&#123;</span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__GNUC__</span></span>        <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">__format__</span><span class="token punctuation">(</span>printf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>    <span class="token keyword">void</span> <span class="token function">bench_mark</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>task<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>    <span class="token punctuation">&#125;</span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">bench_mark</span><span class="token expression"><span class="token punctuation">(</span>t<span class="token punctuation">,</span>f<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">do</span> <span class="token punctuation">&#123;</span></span><span class="token punctuation">\</span>    <span class="token expression"><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>b<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">=</span> t<span class="token punctuation">;</span></span><span class="token punctuation">\</span>    <span class="token expression">b <span class="token operator">?</span> <span class="token function">b</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span><span class="token expression"><span class="token punctuation">&#125;</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>header æ–‡ä»¶é‡Œé¢ï¼Œåœ¨DEBUGç¯å¢ƒä¸‹éœ€è¦è¯´æ˜çš„æ˜¯<code>__attribute__((__format__(printf, 2, 3)))</code>.  è¿™ä¸ªæ˜¯ç¼–è¯‘å™¨å±æ€§ï¼Œå¯ä»¥æç¤ºç¼–è¯‘å™¨å»æ£€æŸ¥<code>(&quot;%s,%d&quot;,&quot;hello&quot;,1)</code>ç±»å‹åŒ¹é…é—®é¢˜ï¼ŒåŒæ—¶ç»™å‡ºwarning.åœ¨RELEASEç¯å¢ƒä¸‹ï¼Œ<code>bench_mark</code>å‡½æ•°ä¼šæ›¿æ¢æˆä¸€ä¸ªå®ï¼Œåšåˆ°åªæ‰§è¡Œå·¥ç¨‹ä¸­çš„ä»£ç ï¼Œè¿™æ ·å°±å‰¥ç¦»äº†æ—¶é—´æµ‹è¯•ç›¸å…³çš„ä»£ç ï¼Œ åšåˆ°æ— å…¥ä¾µã€‚</p><h3 id="bench-mark-m"><a href="#bench-mark-m" class="headerlink" title="bench_mark.m"></a>bench_mark.m</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">import</span> <span class="token string">"bench_mark.h"</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__GNUC__</span></span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">likely</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">__builtin_expect</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">likely</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span class="token keyword">void</span> <span class="token function">bench_mark</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">^</span>task<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>format<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        va_list ap<span class="token punctuation">;</span>        <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">vsprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> format<span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>        CFAbsoluteTime start <span class="token operator">=</span> <span class="token function">CFAbsoluteTimeGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    CFAbsoluteTime delta <span class="token operator">=</span> <span class="token number">0.f</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>        <span class="token function">task</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        delta <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">CFAbsoluteTimeGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">"Used time:(%.2lfs)-(%.5lfms) %s"</span><span class="token punctuation">,</span> delta<span class="token punctuation">,</span> delta <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>.mæ–‡ä»¶é‡Œé¢éœ€è¦è¯´æ˜ä¸‹ï¼Œä¸ºä»€ä¹ˆåŠ å…¥likelyã€‚åœ¨bench_markçš„ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œblockä¸ºnilçš„æ¦‚ç‡æ˜¯é›¶ã€‚è¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨CPUçš„å†’é™©æœºåˆ¶ï¼Œåšåˆ°æ›´å‡†çš„æµ‹è¯•taskä¸­çš„è¿è¡Œæ—¶é—´ã€‚</p><h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><pre class="line-numbers language-objc" data-language="objc"><code class="language-objc">bench_mark(^&#123;    [self logicCode];&#125;, &quot;%s, %s&quot;,&quot;&gt;&gt; as filter key work&quot;, __FILE__);bench_mark(nil,&quot;Hi, boy~&quot;);bench_mark(nil,nil);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="æºä»£ç "><a href="#æºä»£ç " class="headerlink" title="æºä»£ç "></a>æºä»£ç </h2><p><a href="https://github.com/liangxiuchen/bench_mark">https://github.com/liangxiuchen/bench_mark</a></p>]]></content>
      
      
      <categories>
          
          <category> å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€äº›å¥½ç”¨çš„å‘½ä»¤å’Œå·¥å…·</title>
      <link href="/blog/2021/09/18/%E4%B8%80%E4%BA%9B%E5%A5%BD%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E5%92%8C%E5%B7%A5%E5%85%B7/"/>
      <url>/blog/2021/09/18/%E4%B8%80%E4%BA%9B%E5%A5%BD%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4%E5%92%8C%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<h1 id="å·¥ä½œä¸­èƒ½æé«˜æ•ˆç‡çš„å‘½ä»¤å’Œå·¥å…·"><a href="#å·¥ä½œä¸­èƒ½æé«˜æ•ˆç‡çš„å‘½ä»¤å’Œå·¥å…·" class="headerlink" title="å·¥ä½œä¸­èƒ½æé«˜æ•ˆç‡çš„å‘½ä»¤å’Œå·¥å…·"></a>å·¥ä½œä¸­èƒ½æé«˜æ•ˆç‡çš„å‘½ä»¤å’Œå·¥å…·</h1><h2 id="tldr"><a href="#tldr" class="headerlink" title="tldr"></a>tldr</h2><p>æ‘˜è¦ï¼štoo long, donâ€™t read(tldr)</p><p>å¥½ç”¨ä¹‹å¤„ï¼šè§åçŸ¥æ„ï¼Œåœ¨ç±»Unixç³»ç»Ÿä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„å‘½ä»¤<code>man</code>ï¼Œæ˜¯å¤§å®¶æ¯å¤©å·¥ä½œéƒ½ç¦»ä¸æ¥çš„ã€‚ä½†æ˜¯ï¼Œå®ƒæ‰€å‘ˆç°çš„æ–‡æ¡£å¤ªè¯¦ç»†ï¼Œå¤ªé•¿ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•é«˜æ•ˆçš„æŸ¥è¯¢å¸¸ç”¨çš„å‘½ä»¤ã€‚æ‰€è°“çš„äºŒå…«å®šå¾‹ï¼Œè¢«è¿™ä¸ªå‘½ä»¤å¾ˆå¥½çš„è¯ é‡Šã€‚</p><p>ç”¨æ³•ï¼štldr [å‘½ä»¤]</p><p>å®˜ç½‘ï¼š<a href="https://tldr.sh/">https://tldr.sh/</a></p><h2 id="Vim"><a href="#Vim" class="headerlink" title="Vim"></a>Vim</h2><p>æ‘˜è¦ï¼šé”®ä½æ˜ å°„</p><ol><li>ç‰©ç†é”®ç›˜ä¸Šçš„Cap Locké”®ä½å‡ ä¹æ²¡ä»€ä¹ˆä½œç”¨ï¼Œå¯ä»¥åœ¨ç³»ç»Ÿè®¾ç½®-&gt;é”®ç›˜è®¾ç½®ä¸­æŠŠå®ƒæ˜ å°„æˆCTRLé”®ã€‚</li><li>åœ¨.vimrcæ–‡ä»¶ä¸­ç”¨CTRL-j ç»„åˆæ¥æ˜ å°„æˆESCé”®ä½ã€‚</li></ol><p>è¿™æ ·å¤„ç†äº†ï¼Œå°±èƒ½å¤§å¤§æé«˜Vim ç¼–è¾‘æ•ˆç‡äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç¬”è®° </tag>
            
            <tag> å‘½ä»¤ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é‡æŒ‡é’ˆ</title>
      <link href="/blog/2021/08/20/%E9%87%8E%E6%8C%87%E9%92%88/"/>
      <url>/blog/2021/08/20/%E9%87%8E%E6%8C%87%E9%92%88/</url>
      
        <content type="html"><![CDATA[<h1 id="é‡æŒ‡é’ˆ"><a href="#é‡æŒ‡é’ˆ" class="headerlink" title="é‡æŒ‡é’ˆ"></a>é‡æŒ‡é’ˆ</h1><p>å„ä½å¤§ä½¬åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œç›¸ä¿¡è‚¯å®šé‡åˆ°è¿‡é‡æŒ‡é’ˆçš„crashã€‚ä½†æ˜¯åœ¨Cæˆ–è€…C++ä¸­é‡æŒ‡é’ˆä¸€å®šä¼šå¯¼è‡´å¥”æºƒå—ï¼Ÿ</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">//åœ¨å †ä¸Šï¼Œåˆ†é…ä¸€ä¸ªintç±»å‹å¤§çš„å†…å­˜ç©ºé—´</span><span class="token keyword">void</span> <span class="token operator">*</span>pi <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//é‡Šæ”¾piæŒ‡å‘çš„å†…å­˜ã€‚delete æ€ä¹ˆçŸ¥é“éœ€è¦å›æ”¶å¤šå°‘å†…å­˜ï¼Œæˆ‘ä»¬è¿™é‡Œåªä¼ å…¥äº†ä¸€ä¸ªåœ°å€è€Œå·²ã€‚</span><span class="token function">free</span><span class="token punctuation">(</span>pi<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç°åœ¨piå·²ç»æ˜¯æ‚¬æŒ‚çš„é‡æŒ‡é’ˆäº†</span><span class="token keyword">int</span> <span class="token operator">*</span>p_i <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>pi<span class="token punctuation">;</span><span class="token comment">//å†™ä¸€ä¸ªé‡æŒ‡é’ˆ</span><span class="token operator">*</span>p_i <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token comment">//è¯»å–ä¸€ä¸ªé‡æŒ‡é’ˆ</span><span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token operator">*</span>p_i<span class="token punctuation">;</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%p-%p:%d\n"</span><span class="token punctuation">,</span>pi<span class="token punctuation">,</span> p_i<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¸Šé¢ä»£ç ä¼šå¥”æºƒå—ï¼Ÿå°ä¼™ä¼´ä»¬å¯ä»¥å°è¯•ä¸‹ã€‚ç­”æ¡ˆæ˜¯è¿™ä¸ªcaseæ˜¯è‚¯å®šä¸ä¼šcrashã€‚ä¸ºä»€ä¹ˆ?</p><h2 id="å†…å­˜è®¿é—®åŸç†"><a href="#å†…å­˜è®¿é—®åŸç†" class="headerlink" title="å†…å­˜è®¿é—®åŸç†"></a>å†…å­˜è®¿é—®åŸç†</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬ä¸Šå±‚åº”ç”¨ç¨‹åºæ‰€å¾—åˆ°çš„éƒ½æ˜¯è™šæ‹Ÿå†…å­˜ã€‚å½“æˆ‘ä»¬ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„<code>malloc</code>æ¥åˆ†é…å†…å­˜çš„æ—¶å€™ï¼Œæ ‡å‡†åº“ä¼šè°ƒç”¨æ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æ¥å£<code>brk(size_t)</code>ï¼Œæ¥å‘æ“ä½œä½“ç³»ç”³è¯·å †ç©ºé—´ã€‚æ­¤æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šåˆ†é…ä¸€éƒ¨åˆ†è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼Œå¹¶åœ¨å†…æ ¸è¿›ç¨‹è®°è´¦ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬<code>free</code>äº†è¿™å—å†…å­˜ï¼Œå…¶å®ä»…ä»…åªæ˜¯åƒæ ‡å‡†åº“è¯´æ˜äº†ï¼Œæˆ‘ä»¬é‡Šæ”¾äº†è¿™ç‰‡å†…å­˜ã€‚è¿™æ ·ï¼Œæ ‡å‡†åº“å¯ä»¥åœ¨ä¸‹æ¬¡ï¼Œé‡æ–°åˆ†é…è¿™ç‰‡å†…å­˜ç»™åˆ«çš„å˜é‡ã€‚ä½†æ˜¯åœ¨æ“ä½œç³»ç»Ÿçœ‹æ¥ï¼Œè¿™ç‰‡å†…å­˜è¿˜æ˜¯è¢«ä½ çš„åº”ç”¨ä½¿ç”¨ç€ã€‚æ‰€ä»¥ï¼Œå½“ä½ ç”¨<code>*pi_i</code>å»è¯»å–æˆ–è€…å†™å…¥ï¼Œéƒ½æ˜¯åˆæ³•çš„ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä»£ç ç‰‡æ®µæ‰§è¡Œéƒ½æ˜¯ä¸ä¼šcrashçš„ã€‚</p><h2 id="crashçš„åœºæ™¯"><a href="#crashçš„åœºæ™¯" class="headerlink" title="crashçš„åœºæ™¯"></a>crashçš„åœºæ™¯</h2><ul><li><code>free</code>é‡å¤è°ƒç”¨ã€‚å½“ä½ ç¬¬ä¸€æ¬¡è°ƒç”¨<code>free</code>, æ ‡å‡†åº“ä¼šè®°è´¦å›æ”¶ã€‚æ­¤æ—¶ï¼Œä½ å†é‡å¤é‡Šæ”¾ï¼Œæ ‡å‡†åº“å°±ä¼šæ‰§è¡Œå¥”æºƒæµç¨‹äº†ã€‚</li><li>è¿™ç‰‡å†…å­˜åˆ«é‡æ–°åˆ†é…ç»™äº†åˆ«çš„å˜é‡ï¼Œç„¶åé‡æŒ‡é’ˆå˜é‡ç ´åäº†è¿™éƒ¨åˆ†æ•°æ®ï¼Œéƒ½å¯èƒ½é€ æˆæ®µé”™è¯¯ï¼Œéæ³•æŒ‡ä»¤ç­‰å¥”æºƒã€‚</li></ul><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>åœ¨åˆ©ç”¨æŒ‡é’ˆçš„æ—¶å€™ï¼Œå…»æˆé‡Šæ”¾äº†å†…å­˜ï¼Œå¯¹åº”å˜é‡ä¹Ÿéœ€è¦è®¾æˆ<code>nil</code>ã€‚ è¿™æ ·å³ä½¿å¥”æºƒäº†ï¼Œä¹Ÿå¥½å®šä½ã€‚ä¸ç„¶çš„è¯ï¼Œé‡æŒ‡é’ˆèƒ½å¯¼è‡´çš„crashæœ‰æ—¶å€™çœŸçš„å¾ˆéš¾å®šä½ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> å†…å­˜ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> C </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å§‹</title>
      <link href="/blog/2021/08/13/whishStart/"/>
      <url>/blog/2021/08/13/whishStart/</url>
      
        <content type="html"><![CDATA[<h1 id="è‡´è°¢å®¶äºº"><a href="#è‡´è°¢å®¶äºº" class="headerlink" title="è‡´è°¢å®¶äºº"></a>è‡´è°¢å®¶äºº</h1><p>å·²ç»åšiOSå¼€å‘å¿«5å¹´äº†ï¼Œä¸­é—´æœ‰æˆé•¿ä¹Ÿæœ‰è¿·æƒ‘ã€‚æˆ‘æƒ³è¿™æ˜¯æ¯ä¸€ä¸ªITäººï¼Œåªè¦ä½ æ˜¯ææŠ€æœ¯çš„ï¼Œéƒ½æ˜¯éœ€è¦ä¸æ–­å­¦ä¹ ã€‚æ‰€ä»¥åšå®¢æ˜¯æœ€å¥½çš„ç¬”è®°æœ¬ï¼Œåœ¨è¿™é‡Œä½ å¯ä»¥åˆ†äº«ä½ çš„è®¤çŸ¥ã€‚åŒæ—¶ä¹Ÿæ˜¯é‡æ¸©å’Œå·©å›ºè‡ªå·±æ‰€å­¦çš„ã€‚3å¹´ä¹‹å‰ï¼Œæˆ‘ä¹Ÿæ˜¯æ­å»ºè¿‡ä¸€ä¸ªåšå®¢ï¼Œä½†æ˜¯é‚£ä¸ªåšå®¢æˆ‘æ‡’æ‡’æ•£æ•£åœ°å†™äº†å‡ ç¯‡æŠ€æœ¯æ–‡ç« å°±æ²¡æœ‰å†å»æ›´æ–°è¿‡äº†ã€‚</p><p>è¿™æ¬¡æˆ‘é‡æ„äº†ï¼Œåšå®¢ç”¨æ¥è®°å½•æˆ‘å¹³æ—¶çš„ç”Ÿæ´»å’Œå­¦ä¹ ã€‚ç™½é©¹è¿‡éš™å’Œ4å¹´å‰ç›¸æ¯”ï¼Œæˆ‘ç°åœ¨å·²ç»ä¸ºäººå¤«ä¸ºäººçˆ¶ã€‚åœ¨æ­¤ï¼Œæˆ‘é¦–å…ˆæ„Ÿè°¢æˆ‘çš„è€å©†ï¼Œä¸ºæˆ‘ç”Ÿäº†ä¸€ä¸ªé‚£ä¹ˆå¯çˆ±çš„å„¿å­ï¼Œæ„Ÿè°¢ä¸ˆæ¯å¨˜è¾›è‹¦å¸¦å¨ƒã€‚å¥½äº†ï¼Œä»Šå¤©å°±æ­¢äºæ­¤ï¼Œåšå®¢å§‹äºæ­¤ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> ç”Ÿæ´» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç”Ÿæ´» </tag>
            
            <tag> æ„Ÿæƒ³ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
